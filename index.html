<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js'></script>
    <script type='text/javascript' src='https://d3js.org/topojson.v3.min.js'></script>
    <title>info4310 HW2</title>
</head>

<style>
    h3,
    p {
        font-size: 22px;
    }

    .background {
        fill: none;
        pointer-events: all;
    }

    /* #states {
        fill: #aaa;
    } */

    #states .active {
        display: none;
    }

    #state-borders {
        stroke-width: 1.5px;
        stroke-linejoin: round;
        stroke-linecap: round;
        pointer-events: none;
        fill: none;
    }

    .county-boundary {
        stroke-width: .5px;
    }
</style>

<body>
    <h3>Destiny Malloy (dam359), Marcella Imoisili (mii7)</h3>
    <p id='p1'><strong>2016 U.S. Poll Data </strong></br>
        <svg id='viz' height='1100' width='1450'></svg>
        <script>
            //python3 -m http.server
            const svg = d3.select('#viz');
            const width = svg.attr('width');
            const height = svg.attr('height');
            // var active = d3.select(null);
            var active = null;


            const margin = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 20
            };

            const getData = async function () {

                const us = await d3.json('us.json');

                var projection = d3.geoAlbersUsa()
                    .translate([width / 2, height / 2])
                    .scale(width);

                var path = d3.geoPath()
                    .projection(projection);

                var g = svg.append('g')
                    .attr('class', 'center-container center-items us-state')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)

                var stateData = await d3.csv('election_byState.csv');
                console.log(stateData);

                idToStatePercentLead = {}
                idToCountyPercentLead = {}

                stateData.forEach(d => {
                    //d['stateCode'] = d['state_abbr'];
                    d['D_percent_lead'] = Number(d['%diff_dem_favor']).toFixed(2);
                    d['percent_D'] = Number(d['%dem']);
                    d['percent_R'] = Number(d['%rep']);
                    d['id'] = Number(d['state_id']);
                    idToStatePercentLead[d.id] = d.D_percent_lead;

                });

                //console.log(stateData);

                var countyData = await d3.csv('electionResults_byCounty.csv');
                console.log(countyData);

                countyData.forEach(d => {
                    d['D_percent_lead'] = Number(d['%difference(d_favor)']).toFixed(2);
                    d['percent_D'] = Number(d['percent_democrat']);
                    d['percent_R'] = Number(d['percent_republican']);
                    d['FIPS'] = d.FIPS;
                    idToCountyPercentLead[d.FIPS] = d['D_percent_lead']
                })


                const leadExtent = d3.extent(stateData, d => Number(d['D_percent_lead']));
                const countyLeadExtent = d3.extent(countyData, d => Number(d['D_percent_lead']));
                console.log(leadExtent)
                console.log(countyLeadExtent)

                // const colorScale = d3.scaleQuantize().domain(leadExtent)
                //     .range(['#D93333', '#DE8181', '#DCD2D2', '#7A8FDD', '#3357DC']);


                //-25 and below
                //below -5
                //above 5
                //above 25
                function colorScale(x) {
                    if (x <= -25) {
                        return '#de533e';
                    } else if (x < -5) {
                        return '#ea9e8d';
                    } else if (x < 5) {
                        return '#e2e2e2';
                    } else if (x < 25) {
                        return '#9898de';
                    } else if (x >= 25) {
                        return '#1c54d6';
                    } else {
                        console.log(x)
                        return '#de533e';
                    }
                }
                // const colorScale = d3.scaleSequential(d3.interpolateRdBu).domain(countyLeadExtent);


                function hover(d) {
                    d3.select(this).attr('stroke-width', '5px');
                }

                function n_hover(d) {
                    d3.select(this).attr('stroke-width', '1.5px');
                }


                function clicked(d) {
                    var dx;
                    var dy;
                    var k;

                    if (d && active !== d) {
                        var centroid = path.centroid(d);
                        dx = centroid[0];
                        dy = centroid[1];
                        k = 4;
                        active = d;
                    } else {
                        dx = width / 2;
                        dy = height / 2;
                        k = 1;
                        active = null;
                    }

                    g.selectAll('path')
                        .classed('active', active && function (d) {
                            return d === active;
                        });

                    g.transition()
                        .duration(300)
                        .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + k + ')translate(' + -dx + ',' + -dy + ')')
                        .style('stroke-width', 1.5 / k + 'px');
                }

                function reset() {
                    g.selectAll('path')
                        .classed('active', false);
                    active = null;


                    g.transition()
                        .duration(500)
                        .style('stroke-width', '1.5px')
                        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

                };

                g.append('g')
                    .attr('id', 'counties')
                    .selectAll('path')
                    .data(topojson.feature(us, us.objects.counties).features)
                    .enter().append("path")
                    .attr("d", path)
                    // .attr("fill", "#EBEBEB")
                    .attr('fill', d => colorScale(idToCountyPercentLead[d.id]))
                    .attr("stroke", "black")
                    .attr("class", "county-boundary")
                    .attr('note', d => d.id)
                    .on("click", reset)
                    .on("mouseover", hover)
                    .on("mouseout", n_hover);

                g.append("g")
                    .attr("id", "states")
                    .selectAll("path")
                    .data(topojson.feature(us, us.objects.states).features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr('fill', d => colorScale(idToStatePercentLead[d.id]))
                    // .attr("fill", '#EBEBEB')
                    .attr("stroke", "black")
                    .attr("class", "state")
                    .attr("note", d => d.id)
                    // .on("click", clicked);
                    .on("mouseover", hover)
                    .on("mouseout", n_hover)
                    .on("click", clicked);


                g.append("path")
                    .datum(topojson.mesh(us, us.objects.states, function (i, j) {
                        return i !== j;
                    }))
                    .attr('id', 'state-borders')
                    .attr('d', path);

            };
            getData();
        </script>
    </p>
</body>

</html>