<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/topojson.v3.min.js"></script>
    <title>info4310 HW2</title>
</head>

<style>
    h3,
    p {
        font-size: 22px;
    }

    .background {
        fill: none;
        pointer-events: all;
    }

    /* #states {
        fill: #aaa;
    } */

    #states .active {
        display: none;
    }

    #state-borders {
        stroke-width: 1.5px;
        stroke-linejoin: round;
        stroke-linecap: round;
        pointer-events: none;
        fill: none;
    }

    .county-boundary {
        stroke-width: .5px;
    }
</style>

<body>
    <h3>Destiny Malloy (dam359), Marcella Imoisili (mii7)</h3>
    <p id="p1"><strong>Visualization of Historical U.S. Poll Data </strong></br>
        <svg id="viz" height="900" width="1500"></svg>
        <script>
            //python3 -m http.server
            const svg = d3.select("#viz");
            const width = svg.attr("width");
            const height = svg.attr("height");
            var active = d3.select(null);

            const margin = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 20
            };

            const getData = async function () {

                const us = await d3.json('us.json');

                var projection = d3.geoAlbersUsa()
                    .translate([width / 2, height / 2])
                    .scale(width);

                var path = d3.geoPath()
                    .projection(projection);

                var g = svg.append("g")
                    .attr('class', 'center-container center-items us-state')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)


                // g.append("g")
                //     .attr("id", "counties")
                //     .selectAll("path")
                //     .data(topojson.feature(us, us.objects.counties).features)
                //     .enter().append("path")
                //     .attr("d", path)
                //     .attr("fill", "#EBEBEB")
                //     .attr("stroke", "black")
                //     .attr("class", "county-boundary")
                //     .on("click", reset);

                var stateData = await d3.csv('electionResults_byState_2016.csv');
                console.log(stateData);

                idToStateCode = {}
                idToStateName = {}


                stateData.forEach(d => {
                    d['stateCode'] = d['state_abbr'];
                    d['D_percent_lead'] = Number(d['%diff_dem_favor']).toFixed(2);
                    d['percent_D'] = Number(d['%dem']);
                    d['percent_R'] = Number(d['%rep']);

                });

                console.log(stateData);

                const leadExtent = d3.extent(stateData, d => Number(d['D_percent_lead']));
                console.log(leadExtent)

                const colorScale = d3.scaleSequential(d3.schemeRdBu[5]).domain(leadExtent);


                function hover(d) {
                    d3.select(this).attr('stroke-width', '5px');
                }

                function n_hover(d) {
                    d3.select(this).attr('stroke-width', '1.5px');
                }

                function clicked(d) {
                    if (d3.select('.background').node() === this) return reset();

                    if (active.node() === this) return reset();

                    active.classed("active", false);
                    active = d3.select(this).classed("active", true);

                    var bounds = path.bounds(d),
                        dx = bounds[1][0] - bounds[0][0],
                        dy = bounds[1][1] - bounds[0][1],
                        x = (bounds[0][0] + bounds[1][0]) / 2,
                        y = (bounds[0][1] + bounds[1][1]) / 2,
                        scale = .9 / Math.max(dx / width, dy / height),
                        translate = [width / 2 - scale * x, height / 2 - scale * y];

                    g.transition()
                        .duration(750)
                        .style("stroke-width", 1.5 / scale + "px")
                        .attr("transform", "translate(" + translate + ")scale(" + scale + ")");
                }

                function reset() {
                    active.classed("active", false);
                    active = d3.select(null);


                    g.transition()
                        .delay(100)
                        .duration(750)
                        .style("stroke-width", "1.5px")
                        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

                };

                g.append("g")
                    .attr("id", "counties")
                    .selectAll("path")
                    .data(topojson.feature(us, us.objects.counties).features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("fill", "#EBEBEB")
                    .attr("stroke", "black")
                    .attr("class", "county-boundary")
                    .on("click", reset);

                g.append("g")
                    .attr("id", "states")
                    .selectAll("path")
                    .data(topojson.feature(us, us.objects.states).features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("fill", '#EBEBEB')
                    .attr("stroke", "black")
                    .attr("class", "state")
                    .attr("note", d => d.id)
                    // .on("click", clicked);
                    .on("mouseover", hover)
                    .on("mouseout", n_hover)
                    .on("click", clicked);


                g.append("path")
                    .datum(topojson.mesh(us, us.objects.states, function (i, j) {
                        return i !== j;
                    }))
                    .attr("id", "state-borders")
                    .attr("d", path);

            }


            getData();
        </script>
    </p>
</body>

</html>